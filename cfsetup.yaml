everything: &everything
  build:
    builddeps: &deps
      - rust
    pre-cache-copy-paths: &paths
      - engine/Cargo.toml
      - ffi/Cargo.toml
      - Cargo.lock
      - Cargo.toml
      - cfsetup-cargo.sh
    pre-cache:
      - ./cfsetup-cargo.sh prebuild --release
      - ./cfsetup-cargo.sh install cargo-deb
    post-cache:
      - cd ffi
      - sudo ../cfsetup-cargo.sh build --release --frozen
      # Copy artifact so that package.metadata.deb.assets could find it
      # (see https://github.com/mmstick/cargo-deb/issues/48)
      - mkdir -p ../target/release
      - cp /var/lib/cargo/target/release/libwirefilter.so ../target/release
      - sudo ../cfsetup-cargo.sh deb --no-build
    artifacts:
      - /var/lib/cargo/target/debian/*.deb
  test:
    builddeps: *deps
    pre-cache-copy-paths: *paths
    pre-cache:
      - ./cfsetup-cargo.sh prebuild
    post-cache:
      - sudo ./cfsetup-cargo.sh test --frozen
jessie: *everything
stretch: *everything
