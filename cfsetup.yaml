everything: &everything
  build: &build
    builddeps: &builddeps
      - rust
      - cargo-deb
    pre-cache-copy-paths: &paths
      - engine/Cargo.toml
      - ffi/Cargo.toml
      - Cargo.lock
      - Cargo.toml
      - cfsetup-cargo.sh
    pre-cache:
      - ./cfsetup-cargo.sh prebuild --release
    post-cache:
      - cd ffi
      - sudo ../cfsetup-cargo.sh build --release --frozen
      - sudo ../cfsetup-cargo.sh deb --no-build
    artifacts:
      - /var/lib/cargo/target/debian/*.deb
  build-arm64:
    <<: *build
    target-arch: arm64
  test:
    builddeps: *builddeps
    pre-cache-copy-paths: *paths
    pre-cache: &test-pre-cache
      - ./cfsetup-cargo.sh prebuild
    post-cache:
      - sudo ./cfsetup-cargo.sh test --frozen
  bamboo-test:
    builddeps:
      - rust
      - cargo-to-teamcity
    pre-cache-copy-paths: *paths
    pre-cache: *test-pre-cache
    post-cache:
      - sudo ./cfsetup-cargo.sh test --frozen | cargo-to-teamcity

stretch: *everything
jessie: *everything
